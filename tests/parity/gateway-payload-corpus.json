{
  "cases": [
    {
      "name": "chat.inject emits final chat payload shape",
      "prelude": [
        {
          "id": "prelude-chat-send-seed",
          "method": "chat.send",
          "params": {
            "sessionKey": "main",
            "message": "seed message",
            "idempotencyKey": "chat-seed-run"
          }
        }
      ],
      "request": {
        "id": "req-chat-inject-parity",
        "method": "chat.inject",
        "params": {
          "sessionKey": "main",
          "message": "operator note",
          "label": "ops"
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/ok",
            "equals": true
          },
          {
            "path": "/messageId",
            "kind": "string",
            "nonEmpty": true
          }
        ],
        "event": {
          "name": "chat",
          "checks": [
            {
              "path": "/runId",
              "kind": "string",
              "startsWith": "inject-"
            },
            {
              "path": "/sessionKey",
              "equals": "agent:main:main"
            },
            {
              "path": "/seq",
              "equals": 0
            },
            {
              "path": "/state",
              "equals": "final"
            },
            {
              "path": "/message/id",
              "kind": "string",
              "nonEmpty": true
            },
            {
              "path": "/message/parentId",
              "kind": "string",
              "nonEmpty": true
            },
            {
              "path": "/message/role",
              "equals": "assistant"
            },
            {
              "path": "/message/content",
              "equals": "[ops] operator note"
            }
          ]
        }
      }
    },
    {
      "name": "chat.history keeps id parentId chain fields",
      "prelude": [
        {
          "id": "prelude-chat-send-a",
          "method": "chat.send",
          "params": {
            "sessionKey": "main",
            "message": "batch-a",
            "idempotencyKey": "chat-run-a"
          }
        },
        {
          "id": "prelude-chat-send-b",
          "method": "chat.send",
          "params": {
            "sessionKey": "main",
            "message": "batch-b",
            "idempotencyKey": "chat-run-b"
          }
        },
        {
          "id": "prelude-chat-inject-history",
          "method": "chat.inject",
          "params": {
            "sessionKey": "main",
            "message": "operator note",
            "label": "ops"
          }
        }
      ],
      "request": {
        "id": "req-chat-history-parity",
        "method": "chat.history",
        "params": {
          "sessionKey": "main",
          "limit": 3
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/sessionKey",
            "equals": "agent:main:main"
          },
          {
            "path": "/sessionId",
            "kind": "string",
            "nonEmpty": true
          },
          {
            "path": "/messages",
            "kind": "array",
            "nonEmpty": true
          },
          {
            "path": "/messages/0/id",
            "kind": "string"
          },
          {
            "path": "/messages/0/parentId",
            "kind": "null"
          },
          {
            "path": "/messages/1/parentId",
            "kind": "string",
            "nonEmpty": true
          },
          {
            "path": "/messages/2/parentId",
            "kind": "string",
            "nonEmpty": true
          },
          {
            "path": "/messages/2/role",
            "equals": "assistant"
          },
          {
            "path": "/messages/2/content",
            "equals": "[ops] operator note"
          }
        ]
      }
    },
    {
      "name": "chat.send rejects null bytes with bad request",
      "request": {
        "id": "req-chat-send-null-byte-parity",
        "method": "chat.send",
        "params": {
          "sessionKey": "main",
          "message": "hello\u0000world",
          "idempotencyKey": "chat-null-byte"
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "null bytes"
        }
      }
    },
    {
      "name": "tts.status returns provider and prefs shape",
      "request": {
        "id": "req-tts-status-parity",
        "method": "tts.status",
        "params": {}
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/enabled",
            "equals": false
          },
          {
            "path": "/provider",
            "equals": "edge"
          },
          {
            "path": "/prefsPath",
            "equals": "memory://tts/prefs.json"
          },
          {
            "path": "/fallbackProviders",
            "kind": "array",
            "nonEmpty": true
          },
          {
            "path": "/edgeEnabled",
            "equals": true
          }
        ]
      }
    },
    {
      "name": "tts.setProvider rejects unknown provider",
      "request": {
        "id": "req-tts-set-provider-invalid-parity",
        "method": "tts.setProvider",
        "params": {
          "provider": "invalid-provider"
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "Invalid provider"
        }
      }
    },
    {
      "name": "tts.convert returns opus payload for telegram",
      "prelude": [
        {
          "id": "prelude-tts-set-provider-openai",
          "method": "tts.setProvider",
          "params": {
            "provider": "openai"
          }
        }
      ],
      "request": {
        "id": "req-tts-convert-parity",
        "method": "tts.convert",
        "params": {
          "text": "hello voice",
          "channel": "telegram"
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/audioPath",
            "kind": "string",
            "startsWith": "memory://tts/audio-",
            "contains": ".opus"
          },
          {
            "path": "/provider",
            "equals": "openai"
          },
          {
            "path": "/outputFormat",
            "equals": "opus"
          },
          {
            "path": "/voiceCompatible",
            "equals": true
          }
        ]
      }
    },
    {
      "name": "tts.providers exposes active provider catalog",
      "prelude": [
        {
          "id": "prelude-tts-set-provider-openai-providers",
          "method": "tts.setProvider",
          "params": {
            "provider": "openai"
          }
        }
      ],
      "request": {
        "id": "req-tts-providers-parity",
        "method": "tts.providers",
        "params": {}
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/active",
            "equals": "openai"
          },
          {
            "path": "/providers",
            "kind": "array",
            "nonEmpty": true
          },
          {
            "path": "/providers/0/id",
            "equals": "openai"
          },
          {
            "path": "/providers/1/id",
            "equals": "elevenlabs"
          },
          {
            "path": "/providers/2/id",
            "equals": "edge"
          },
          {
            "path": "/providers/2/configured",
            "equals": true
          }
        ]
      }
    },
    {
      "name": "voicewake.set normalizes triggers and emits changed event",
      "request": {
        "id": "req-voicewake-set-parity",
        "method": "voicewake.set",
        "params": {
          "triggers": [
            "  hello  ",
            "",
            "world",
            42
          ]
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/triggers",
            "equals": [
              "hello",
              "world"
            ]
          }
        ],
        "event": {
          "name": "voicewake.changed",
          "checks": [
            {
              "path": "/triggers",
              "equals": [
                "hello",
                "world"
              ]
            }
          ]
        }
      }
    },
    {
      "name": "voicewake.get returns updated trigger set",
      "prelude": [
        {
          "id": "prelude-voicewake-set-updated",
          "method": "voicewake.set",
          "params": {
            "triggers": [
              "hello",
              "world"
            ]
          }
        }
      ],
      "request": {
        "id": "req-voicewake-get-parity",
        "method": "voicewake.get",
        "params": {}
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/triggers",
            "equals": [
              "hello",
              "world"
            ]
          }
        ]
      }
    },
    {
      "name": "voicewake.set rejects non-array triggers",
      "request": {
        "id": "req-voicewake-set-invalid-parity",
        "method": "voicewake.set",
        "params": {
          "triggers": "openclaw"
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "requires triggers: string[]"
        }
      }
    },
    {
      "name": "web.login.start returns qr payload shape",
      "request": {
        "id": "req-web-login-start-parity",
        "method": "web.login.start",
        "params": {
          "timeoutMs": 6000,
          "verbose": true
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/providerId",
            "equals": "whatsapp"
          },
          {
            "path": "/accountId",
            "equals": "default"
          },
          {
            "path": "/sessionId",
            "kind": "string",
            "startsWith": "web-login-"
          },
          {
            "path": "/qrDataUrl",
            "kind": "string",
            "startsWith": "data:image/png;base64,"
          },
          {
            "path": "/verbose",
            "equals": true
          }
        ]
      }
    },
    {
      "name": "web.login.wait reports connected after start",
      "prelude": [
        {
          "id": "prelude-web-login-start",
          "method": "web.login.start",
          "params": {
            "timeoutMs": 6000,
            "verbose": false
          }
        }
      ],
      "request": {
        "id": "req-web-login-wait-connected-parity",
        "method": "web.login.wait",
        "params": {
          "timeoutMs": 5000
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/providerId",
            "equals": "whatsapp"
          },
          {
            "path": "/accountId",
            "equals": "default"
          },
          {
            "path": "/connected",
            "equals": true
          },
          {
            "path": "/message",
            "kind": "string",
            "contains": "Linked!"
          }
        ]
      }
    },
    {
      "name": "web.login.wait reports inactive when no session exists",
      "request": {
        "id": "req-web-login-wait-inactive-parity",
        "method": "web.login.wait",
        "params": {
          "timeoutMs": 5000
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/providerId",
            "equals": "whatsapp"
          },
          {
            "path": "/accountId",
            "equals": "default"
          },
          {
            "path": "/connected",
            "equals": false
          },
          {
            "path": "/message",
            "kind": "string",
            "contains": "No active WhatsApp login in progress."
          }
        ]
      }
    },
    {
      "name": "update.run returns restart sentinel delivery hints",
      "request": {
        "id": "req-update-run-parity",
        "method": "update.run",
        "params": {
          "sessionKey": "agent:main:discord:group:g-upd:topic:42",
          "note": "rollout",
          "restartDelayMs": 2500,
          "timeoutMs": 10
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/ok",
            "equals": true
          },
          {
            "path": "/result/status",
            "equals": "ok"
          },
          {
            "path": "/restart/delayMs",
            "equals": 2500
          },
          {
            "path": "/sentinel/path",
            "kind": "string",
            "startsWith": "memory://restart-sentinel/update-"
          },
          {
            "path": "/sentinel/payload/threadId",
            "equals": "42"
          },
          {
            "path": "/sentinel/payload/deliveryContext/channel",
            "equals": "discord"
          }
        ]
      }
    },
    {
      "name": "sessions.patch canonicalizes main alias key",
      "request": {
        "id": "req-sessions-patch-main-parity",
        "method": "sessions.patch",
        "params": {
          "key": "main",
          "queueMode": "followup"
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/ok",
            "equals": true
          },
          {
            "path": "/path",
            "equals": "memory://session-registry"
          },
          {
            "path": "/key",
            "equals": "agent:main:main"
          },
          {
            "path": "/entry/key",
            "equals": "agent:main:main"
          },
          {
            "path": "/entry/queueMode",
            "equals": "followup"
          },
          {
            "path": "/session/key",
            "equals": "agent:main:main"
          }
        ]
      }
    },
    {
      "name": "sessions.resolve normalizes short session key alias",
      "prelude": [
        {
          "id": "prelude-sessions-patch-short",
          "method": "sessions.patch",
          "params": {
            "key": "discord:group:g-short",
            "queueMode": "followup"
          }
        }
      ],
      "request": {
        "id": "req-sessions-resolve-short-parity",
        "method": "sessions.resolve",
        "params": {
          "key": "discord:group:g-short"
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/ok",
            "equals": true
          },
          {
            "path": "/key",
            "equals": "agent:main:discord:group:g-short"
          }
        ]
      }
    },
    {
      "name": "sessions.list keeps canonical key forms",
      "prelude": [
        {
          "id": "prelude-sessions-patch-main-list",
          "method": "sessions.patch",
          "params": {
            "key": "main",
            "queueMode": "followup"
          }
        }
      ],
      "request": {
        "id": "req-sessions-list-parity",
        "method": "sessions.list",
        "params": {
          "limit": 10
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/path",
            "equals": "memory://session-registry"
          },
          {
            "path": "/sessions",
            "kind": "array",
            "nonEmpty": true
          },
          {
            "path": "/sessions/0/key",
            "equals": "agent:main:main"
          },
          {
            "path": "/count",
            "equals": 1
          }
        ]
      }
    },
    {
      "name": "sessions.preview preserves requested alias key in output",
      "prelude": [
        {
          "id": "prelude-sessions-send-preview",
          "method": "sessions.send",
          "params": {
            "sessionKey": "main",
            "message": "hello preview"
          }
        }
      ],
      "request": {
        "id": "req-sessions-preview-parity",
        "method": "sessions.preview",
        "params": {
          "keys": [
            "main"
          ],
          "limit": 2,
          "maxChars": 120
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/previews",
            "kind": "array",
            "nonEmpty": true
          },
          {
            "path": "/previews/0/key",
            "equals": "main"
          },
          {
            "path": "/previews/0/status",
            "equals": "ok"
          },
          {
            "path": "/previews/0/items/0/text",
            "contains": "hello preview"
          }
        ]
      }
    },
    {
      "name": "sessions.resolve rejects missing selector params",
      "request": {
        "id": "req-sessions-resolve-missing-parity",
        "method": "sessions.resolve",
        "params": {}
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "sessionKey|key|sessionId or label is required"
        }
      }
    },
    {
      "name": "browser.request returns unavailable contract with details payload",
      "request": {
        "id": "req-browser-request-parity",
        "method": "browser.request",
        "params": {
          "method": "get",
          "path": "/tabs",
          "query": {
            "profile": "default"
          },
          "timeoutMs": 0
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 503,
          "messageContains": "browser control is disabled"
        },
        "errorChecks": [
          {
            "path": "/details/method",
            "equals": "GET"
          },
          {
            "path": "/details/path",
            "equals": "/tabs"
          },
          {
            "path": "/details/query/profile",
            "equals": "default"
          }
        ]
      }
    },
    {
      "name": "wizard.start returns running confirm step payload",
      "request": {
        "id": "req-wizard-start-parity",
        "method": "wizard.start",
        "params": {
          "mode": "local",
          "workspace": "."
        }
      },
      "expect": {
        "outcome": "handled",
        "checks": [
          {
            "path": "/sessionId",
            "kind": "string",
            "startsWith": "wizard-"
          },
          {
            "path": "/done",
            "equals": false
          },
          {
            "path": "/status",
            "equals": "running"
          },
          {
            "path": "/step/id",
            "equals": "confirm-setup"
          },
          {
            "path": "/step/executor",
            "equals": "gateway"
          }
        ]
      }
    },
    {
      "name": "wizard.start rejects concurrent running session",
      "prelude": [
        {
          "id": "prelude-wizard-start-running",
          "method": "wizard.start",
          "params": {
            "mode": "local",
            "workspace": "."
          }
        }
      ],
      "request": {
        "id": "req-wizard-start-duplicate-parity",
        "method": "wizard.start",
        "params": {
          "mode": "local",
          "workspace": "."
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 503,
          "messageContains": "wizard already running"
        }
      }
    },
    {
      "name": "wizard.status rejects unknown session id",
      "request": {
        "id": "req-wizard-status-unknown-parity",
        "method": "wizard.status",
        "params": {
          "sessionId": "wizard-missing"
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "wizard not found"
        }
      }
    },
    {
      "name": "wizard.cancel rejects unknown session id",
      "request": {
        "id": "req-wizard-cancel-unknown-parity",
        "method": "wizard.cancel",
        "params": {
          "sessionId": "wizard-missing"
        }
      },
      "expect": {
        "outcome": "error",
        "error": {
          "code": 400,
          "messageContains": "wizard not found"
        }
      }
    }
  ]
}
