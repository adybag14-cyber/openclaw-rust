name: parity-cp0-cp5-gate

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  parity-scoreboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream openclaw
        uses: actions/checkout@v4
        with:
          repository: openclaw/openclaw
          path: openclaw-upstream
          fetch-depth: 1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Generate method surface diff
        shell: pwsh
        run: .\scripts\parity\method-surface-diff.ps1 -Surface both -UpstreamRepoPath .\openclaw-upstream

      - name: Build parity scoreboard
        shell: pwsh
        run: .\scripts\parity\build-scoreboard.ps1 -IncludeGeneratedAt

      - name: Publish parity summary
        shell: pwsh
        run: Get-Content -Raw parity/generated/parity-scoreboard.md >> $env:GITHUB_STEP_SUMMARY

      - name: Upload parity artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parity-scoreboard
          path: |
            parity/generated/method-surface-diff.json
            parity/generated/upstream-methods.base.json
            parity/generated/upstream-methods.handlers.json
            parity/generated/rust-methods.json
            parity/generated/parity-scoreboard.json
            parity/generated/parity-scoreboard.md
            parity/method-surface-report.md

  replay-corpus:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run deterministic replay corpus tests
        run: bash ./scripts/parity/run-replay-corpus.sh

  standalone-gateway-cp1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP1 standalone gateway fixtures
        run: bash ./scripts/parity/run-cp1-gate.sh

  session-routing-cp2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP2 session/routing fixtures
        run: PARITY_ARTIFACT_DIR=parity/generated/cp2 bash ./scripts/parity/run-cp2-gate.sh

      - name: Publish CP2 summary
        if: always()
        run: |
          if [ -f parity/generated/cp2/cp2-gate-summary.md ]; then
            cat parity/generated/cp2/cp2-gate-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CP2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-cp2-artifacts
          path: |
            parity/generated/cp2

  tool-runtime-cp3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP3 tool runtime parity fixtures
        run: PARITY_ARTIFACT_DIR=parity/generated/cp3 bash ./scripts/parity/run-cp3-gate.sh

      - name: Publish CP3 summary
        if: always()
        run: |
          if [ -f parity/generated/cp3/cp3-gate-summary.md ]; then
            cat parity/generated/cp3/cp3-gate-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CP3 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-cp3-artifacts
          path: |
            parity/generated/cp3

  channel-runtime-cp4:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP4 channel runtime parity fixtures
        run: PARITY_ARTIFACT_DIR=parity/generated/cp4 bash ./scripts/parity/run-cp4-gate.sh

      - name: Publish CP4 summary
        if: always()
        run: |
          if [ -f parity/generated/cp4/cp4-gate-summary.md ]; then
            cat parity/generated/cp4/cp4-gate-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CP4 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-cp4-artifacts
          path: |
            parity/generated/cp4

  node-browser-canvas-cp5:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP5 node/browser/canvas/device parity fixtures
        run: PARITY_ARTIFACT_DIR=parity/generated/cp5 bash ./scripts/parity/run-cp5-gate.sh

      - name: Publish CP5 summary
        if: always()
        run: |
          if [ -f parity/generated/cp5/cp5-gate-summary.md ]; then
            cat parity/generated/cp5/cp5-gate-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CP5 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-cp5-artifacts
          path: |
            parity/generated/cp5

  model-provider-cp6:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rust repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CP6 model/auth/failover foundation fixtures
        run: PARITY_ARTIFACT_DIR=parity/generated/cp6 bash ./scripts/parity/run-cp6-gate.sh

      - name: Publish CP6 summary
        if: always()
        run: |
          if [ -f parity/generated/cp6/cp6-gate-summary.md ]; then
            cat parity/generated/cp6/cp6-gate-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CP6 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-cp6-artifacts
          path: |
            parity/generated/cp6
